{% extends "index.html" %}

{% block head %}
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.14.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.14.1/mapbox-gl.css' rel='stylesheet' />
{% endblock %}

{% block content %}

    <div id="map-complete">
    </div>

    <script>

        mapboxgl.accessToken = 'pk.eyJ1Ijoiaml1Y2siLCJhIjoiY2lrcGJ6NWZkMDBiYXZxbHNjdGQzdGllaCJ9.bgTUEJPNl-T44l5t6sNv8g';
        var map = new mapboxgl.Map({
            container: 'map-complete',
            style: 'mapbox://styles/mapbox/streets-v8',
            center: [{{ location.lon }}, 
                     {{ location.lat }}],
            zoom: 15
        });

        var stations = {
          "type": "FeatureCollection",
          "features": [

            {% for station in near_stations %}
            {
              "type": "Feature",
              "geometry": {
                "type": "Point",
                "coordinates": [{{ station.stop_node.longitude }}, 
                                {{ station.stop_node.latitude }}]
              },
              "properties": {
                    "title": "{{ station.code }} - {{ station.name }}",
                    "description": "<div class=\"marker-title\">Make it Mount Pleasant</div><p><a href=\"http://www.mtpleasantdc.com/makeitmtpleasant\" target=\"_blank\" title=\"Opens in a new window\">Make it Mount Pleasant</a> is a handmade and vintage market and afternoon of live entertainment and kids activities. 12:00-6:00 p.m.</p>",
                    "marker-symbol": "bus",
                    "marker-color": "#123456"
                }
            },
            {% endfor %}
            
          ]
        }

map.on('style.load', function () {
    map.addSource("markers", {
        "type": "geojson",
        "data": stations
    });

    map.addLayer({
        "id": "markers",
        "interactive": true,
        "type": "symbol",
        "source": "markers",
        "layout": {
            "icon-image": "{marker-symbol}-15",
            "text-field": "{title}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-offset": [0, 0.6],
            "text-anchor": "top"
        }
    });
});


var popup = new mapboxgl.Popup();


// When a click event occurs near a marker icon, open a popup at the location of
// the feature, with description HTML from its properties.
map.on('click', function (e) {
    map.featuresAt(e.point, {
        radius: 7.5, // Half the marker size (15px).
        includeGeometry: true,
        layer: 'markers'
    }, function (err, features) {

        if (err || !features.length) {
            popup.remove();
            return;
        }

        var feature = features[0];

        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(feature.geometry.coordinates)
            .setHTML(feature.properties.description)
            .addTo(map);
    });
});

// Use the same approach as above to indicate that the symbols are clickable
// by changing the cursor style to 'pointer'.
map.on('mousemove', function (e) {
    map.featuresAt(e.point, {
        radius: 7.5, // Half the marker size (15px).
        layer: 'markers'
    }, function (err, features) {
        map.getCanvas().style.cursor = (!err && features.length) ? 'pointer' : '';
    });
});
    </script>

{% endblock %}